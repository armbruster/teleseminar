<!DOCTYPE html>

<html>
<head>
	<title>First webgl/three.js test</title>
	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0" />
	<script type="text/javascript" src="js/Three.js"></script>
	<script type="text/javascript" src="js/RequestAnimationFrame.js"></script>
	 <script src="js/Detector.js"></script>
	 <script src="js/jquery.min.js"></script>
	<script type="text/javascript">
	window.onload = function () {

		var camera, scene, renderer, projector,
		geometry, mesh, importMesh;
		
		var meshDesk = new Array();	
		var adac_reverse,  adac_nrAdded;
		// a list with all the interactable objects.
		var objects = [];
		// room architecture
		var roomHeight, roomWidth;
		var floor, floorMaterial;
		var roof, roofMaterial;
		var frontWall, frontWallMaterial;
		var backWall, backWallMaterial;
		var leftWall, leftWallMaterial;
		var rightWall, rightWallMaterial;

		// keyboard movement
		var up = false;
			sx = false,
      		dx = false,
      		dw = false,
      		sp = false;

      	var touchable = 'createTouch' in document,
      		touches = []; // array of touch vectors

      	// touch control
      	var c, canvas;
      	var touchable = 'createTouch' in document;

		init();
		animate();


		function init() {

			canvas = document.createElement( 'canvas' );
			c = canvas.getContext( '2d' );
			adac_reverse = 1;
			adac_nrAdded = 0;

			roomWidth = 1000;
			roomHeight = 500;
		
			scene = new THREE.Scene();

			camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 10000 );
			camera.position.z = 900;
			camera.position.y = 200;
			camera.position.x = 400;
			camera.rotation.x = 50;
			scene.add( camera );
	
			
			var material = new THREE.MeshLambertMaterial( { color: 0xFF0000 } );

			//addDeskAndChair(scene, 2);
addRoomEnvironment(scene, objects, roomWidth);			
			
			// Just a reference cube to see how large the imported models are.
			var ref_cube = new THREE.Mesh(
								new THREE.CubeGeometry( 50, 50, 50 ),
								new THREE.MeshBasicMaterial( { color: 0xFF0000 , opacity: 0.5} )								
							);
			// Add the reference cube as an interactable object. 
			objects.push(ref_cube);
			ref_cube.position.set(roomWidth/2, 0, roomWidth/2);
			scene.add( ref_cube );

			ref_cube.position.x=roomWidth / 2;
			ref_cube.position.y=25;
			ref_cube.position.z=roomWidth / 2;

			// floor
			floorMaterial = new THREE.MeshLambertMaterial({ 
			map: THREE.ImageUtils.loadTexture("textures/floor-512.jpg")
			});
        	floor = new THREE.Mesh( new THREE.PlaneGeometry( roomWidth, roomWidth, 4, 4 ), floorMaterial );
 	       	floor.rotation.x = - 90 * ( Math.PI / 180 );
    	   	floor.position.x = roomWidth / 2;
    	   	floor.position.y = 0;
       		floor.position.z = roomWidth / 2;
	        floor.overdraw = true;	
     	   	scene.add( floor );

     	   	roofMaterial = new THREE.MeshLambertMaterial({ 
			map: THREE.ImageUtils.loadTexture("textures/floor-512.jpg")
			});
        	roof = new THREE.Mesh( new THREE.PlaneGeometry( roomWidth, roomWidth, 4, 4 ), roofMaterial );
 	       	roof.rotation.x = - 90 * ( Math.PI / 180 );
    	   	roof.position.x = roomWidth / 2;
    	   	roof.position.y = roomHeight;
       		roof.position.z = roomWidth / 2;
	        roof.overdraw = true;	
     	   	scene.add( roof );

     	   	frontWallMaterial = new THREE.MeshLambertMaterial({ 
			map: THREE.ImageUtils.loadTexture("textures/wall-512.jpg")
			});
        	frontWall = new THREE.Mesh( new THREE.PlaneGeometry( roomWidth, roomHeight, 4, 4 ), frontWallMaterial );
 	       	frontWall.rotation.x = 0 * ( Math.PI / 180 );
    	   	frontWall.position.x = roomWidth / 2;
			frontWall.position.y = roomHeight / 2;
       		frontWall.position.z = 0;
	        frontWall.overdraw = true;	
     	   	scene.add( frontWall );

     	   	backWallMaterial = new THREE.MeshLambertMaterial({ 
			map: THREE.ImageUtils.loadTexture("textures/wall-512.jpg")
			});
        	backWall = new THREE.Mesh( new THREE.PlaneGeometry( roomWidth, roomHeight, 4, 4 ), backWallMaterial );
 	       	backWall.rotation.x = 0 * ( Math.PI / 180 );
    	   	backWall.position.x = roomWidth / 2;
			backWall.position.y = roomHeight / 2;
       		backWall.position.z = roomWidth;
	        backWall.overdraw = true;	
     	   	scene.add( backWall );

     	   	leftWallMaterial = new THREE.MeshLambertMaterial({ 
			map: THREE.ImageUtils.loadTexture("textures/wall-512.jpg")
			});
        	leftWall = new THREE.Mesh( new THREE.PlaneGeometry( roomWidth, roomHeight, 4, 4 ), leftWallMaterial );
 	       	leftWall.rotation.x = 0 * ( Math.PI / 180 );
 	       	leftWall.rotation.y = 90 * ( Math.PI / 180 );
    	   	leftWall.position.x = 0;
			leftWall.position.y = roomHeight / 2;
       		leftWall.position.z = roomWidth / 2;
	        leftWall.overdraw = true;	
     	   	scene.add( leftWall );

     	   	rightWallMaterial = new THREE.MeshLambertMaterial({ 
			map: THREE.ImageUtils.loadTexture("textures/wall-512.jpg")
			});
        	rightWall = new THREE.Mesh( new THREE.PlaneGeometry( roomWidth, roomHeight, 4, 4 ), rightWallMaterial );
 	       	rightWall.rotation.x = 0 * ( Math.PI / 180 );
 	       	rightWall.rotation.y = 90 * ( Math.PI / 180 );
 	       	rightWall.rotation.y = -90 * ( Math.PI / 180 );
    	   	rightWall.position.x = roomWidth;
			rightWall.position.y = roomHeight / 2;
       		rightWall.position.z = roomWidth / 2;
	        rightWall.overdraw = true;	
     	   	scene.add( rightWall );

     	   	document.addEventListener("keydown", onKeyDown, false);
        	document.addEventListener("keyup", onKeyUp, false);

        	if(touchable) {
        		canvas.addEventListener( 'touchstart', onTouchStart, false);
        		canvas.addEventListener( 'touchmove', onTouchMove, false);
        		canvas.addEventListener( 'touchend', onTouchEnd, false);
        		window.onorientationchange = resetCanvas;
        		window.onresize = resetCanvas;
        	}


			renderer = new THREE.WebGLRenderer(  );
      		renderer.setSize( window.innerWidth,window.innerHeight );
      		document.body.appendChild( renderer.domElement );
			
			// create a point light
			var pointLight = new THREE.PointLight(0xFFFFFF);
			pointLight.position.set(roomWidth / 2, roomHeight, roomWidth / 2); //middle of the room		
			scene.add(pointLight);
	               // document.getElementById('debug').innerHTML = "TEST";
			document.body.appendChild( renderer.domElement );

			projector = new THREE.Projector();
			// Add an event for if a mouse button is pressed.
			document.addEventListener( 'mousedown', onDocumentMouseDown, false );
		}
	
		
		function animate() {
			requestAnimationFrame( animate );
			render();
		}
		// Pressing the mouse button
		function onDocumentMouseDown(event) {
			event.preventDefault();
			
			var vector = new THREE.Vector3(( event.clientX / window.innerWidth) * 2 - 1, - (event.clientY / window.innerHeight) * 2 +1 , 0.5 );
			projector.unprojectVector(vector, camera);
			
			var ray = new THREE.Ray( camera.position, vector.subSelf(camera.position).normalize() );
			var intersects = ray.intersectObjects(objects);
			
			if (intersects.length > 0) {
				if (intersects[0].object == objects[1]) {
					document.getElementById('debug').innerHTML = "Will change blackboard to video...";
				}
				intersects[0].object.material.color.setHex(0x0000FF);
			}
		}

		function resetCanvas (e) {
			// resizes and clears the canvas
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
			// scrolls to upper left
			window.scrollTo(0,0);
		}
	

		function onKeyDown(a) { //pressing buttion
		       var b = a.keyCode;
		       if (b == 38 || b == 87) up = true;  //w
		       else if (b == 40 || b == 83) dw = true; //s
		       else if (b == 37 || b == 65) sx = true; //a
		       else if (b == 39 || b == 68) dx = true; //d
		  }
		     
		  function onKeyUp(a) { // letting go button
		       a = a.keyCode;
		       if (a == 38 || a == 87) up = false;
		       else if (a == 40 || a == 83) dw = false;
		       else if (a == 37 || a == 65) sx = false;
		       else if (a == 39 || a == 68) dx = false;
		       else if (a == 32) sp = false;
		  }

		function onTouchStart( event ) {
			touches = e.touches;
		}

		function onTouchMove( event ) {
			// preventing default browser behavior, e.g. scrolling
			event.preventDefault();
			touches = e.touches;
		}

		function onTouchEnd( event ) {
			touches = e.touches;
		}

		function render() {
			
		    if (up && dx) { // up and right
		      camera.position.x += 10;
		      camera.position.z -= 10;
		    }
		    else if (up && sx) { // up and left
		      camera.position.x -= 10;
		      camera.position.z -= 10;
		    }
		    else if (dw && dx) { // down and right
		      camera.position.x += 10;
		      camera.position.z += 10;
		    }
		    else if (dw && sx) { // down anf left
		      camera.position.x -= 10;
		      camera.position.z += 10;
		    }
		    else if (dx){ // right
		      camera.position.x += 20;
		    }
		    else if (sx) { // left
		      camera.position.x -= 20;
		    }
		    else if (up) { // up
		      camera.position.z -= 20;
		    }
		    else if (dw) { // down
		      camera.position.z += 20;
		    }


		    if(touchable) {

				for(var i=0; i<touches.length; i++)
				{
					var touch = touches[i]; 
					c.beginPath(); 
					c.fillStyle = "white";
					c.fillText("touch id : "+touch.identifier+" x:"+touch.clientX+" y:"+touch.clientY, touch.clientX+30, touch.clientY-30); 

					c.beginPath(); 
					c.strokeStyle = "cyan";
					c.lineWidth = "6";
					c.arc(touch.clientX, touch.clientY, 40, 0, Math.PI*2, true); 
					c.stroke();
				}
			}




		    renderer.render( scene, camera );
		}
	};
	</script>

	<script type="text/javascript" src="js/addRoom.js"></script>
	</head>
	<body>
		<div id="debug">
		</div>
	</body>
</html>
